<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Analysis based on Decision Trees, Random Forests, and Neural Networks.">

<title>tabularml - Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="tabularml - Analysis">
<meta property="og:description" content="Analysis based on Decision Trees, Random Forests, and Neural Networks.">
<meta property="og:site-name" content="tabularml">
<meta name="twitter:title" content="tabularml - Analysis">
<meta name="twitter:description" content="Analysis based on Decision Trees, Random Forests, and Neural Networks.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">tabularml</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Analysis</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Tabular ML</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analysis.html" class="sidebar-item-text sidebar-link active">Analysis</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#definitions" id="toc-definitions" class="nav-link active" data-scroll-target="#definitions">Definitions</a></li>
  <li><a href="#load-data" id="toc-load-data" class="nav-link" data-scroll-target="#load-data">Load data</a></li>
  <li><a href="#cleaning-and-eda" id="toc-cleaning-and-eda" class="nav-link" data-scroll-target="#cleaning-and-eda">Cleaning and EDA</a>
  <ul class="collapse">
  <li><a href="#outliers" id="toc-outliers" class="nav-link" data-scroll-target="#outliers">Outliers</a></li>
  <li><a href="#remove-nrofpictures" id="toc-remove-nrofpictures" class="nav-link" data-scroll-target="#remove-nrofpictures">Remove nrOfPictures</a></li>
  <li><a href="#datecreated" id="toc-datecreated" class="nav-link" data-scroll-target="#datecreated">dateCreated</a></li>
  <li><a href="#yearregistration-monthregistration" id="toc-yearregistration-monthregistration" class="nav-link" data-scroll-target="#yearregistration-monthregistration">yearRegistration + monthRegistration</a></li>
  <li><a href="#target-variable" id="toc-target-variable" class="nav-link" data-scroll-target="#target-variable">Target variable</a></li>
  <li><a href="#date-information" id="toc-date-information" class="nav-link" data-scroll-target="#date-information">date information</a></li>
  <li><a href="#histograms" id="toc-histograms" class="nav-link" data-scroll-target="#histograms">Histograms</a></li>
  </ul></li>
  <li><a href="#split-data-and-preprocess" id="toc-split-data-and-preprocess" class="nav-link" data-scroll-target="#split-data-and-preprocess">Split data and preprocess</a></li>
  <li><a href="#decision-tree" id="toc-decision-tree" class="nav-link" data-scroll-target="#decision-tree">Decision Tree</a>
  <ul class="collapse">
  <li><a href="#visualization" id="toc-visualization" class="nav-link" data-scroll-target="#visualization">Visualization</a></li>
  <li><a href="#training" id="toc-training" class="nav-link" data-scroll-target="#training">Training</a></li>
  <li><a href="#evaluation" id="toc-evaluation" class="nav-link" data-scroll-target="#evaluation">Evaluation</a></li>
  </ul></li>
  <li><a href="#random-forest" id="toc-random-forest" class="nav-link" data-scroll-target="#random-forest">Random Forest</a>
  <ul class="collapse">
  <li><a href="#training-1" id="toc-training-1" class="nav-link" data-scroll-target="#training-1">Training</a></li>
  <li><a href="#evaluation-1" id="toc-evaluation-1" class="nav-link" data-scroll-target="#evaluation-1">Evaluation</a></li>
  <li><a href="#visualization-1" id="toc-visualization-1" class="nav-link" data-scroll-target="#visualization-1">Visualization</a></li>
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation">Interpretation</a></li>
  <li><a href="#removing-variables" id="toc-removing-variables" class="nav-link" data-scroll-target="#removing-variables">Removing variables</a></li>
  <li><a href="#removing-redundant-variables" id="toc-removing-redundant-variables" class="nav-link" data-scroll-target="#removing-redundant-variables">Removing redundant variables</a></li>
  </ul></li>
  <li><a href="#neural-network" id="toc-neural-network" class="nav-link" data-scroll-target="#neural-network">Neural Network</a></li>
  <li><a href="#ensemble-of-rf-and-nn" id="toc-ensemble-of-rf-and-nn" class="nav-link" data-scroll-target="#ensemble-of-rf-and-nn">Ensemble of RF and NN</a></li>
  <li><a href="#future-lines-of-work" id="toc-future-lines-of-work" class="nav-link" data-scroll-target="#future-lines-of-work">Future lines of work</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/JaumeAmoresDS/tabularml/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Analysis</h1>
</div>

<div>
  <div class="description">
    Analysis based on Decision Trees, Random Forests, and Neural Networks.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="definitions" class="level2">
<h2 class="anchored" data-anchor-id="definitions">Definitions</h2>
<p>Let us first define some functions used throughout the notebook. We don’t include the imports for the sake of space, but please look at the notebook nbs/analysis.ipynb for details.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> draw_tree(t, df, size<span class="op">=</span><span class="dv">10</span>, ratio<span class="op">=</span><span class="fl">0.6</span>, precision<span class="op">=</span><span class="dv">0</span>, <span class="op">**</span>kwargs):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    s<span class="op">=</span>export_graphviz(t, out_file<span class="op">=</span><span class="va">None</span>, feature_names<span class="op">=</span>df.columns, filled<span class="op">=</span><span class="va">True</span>, rounded<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                      special_characters<span class="op">=</span><span class="va">True</span>, rotate<span class="op">=</span><span class="va">False</span>, precision<span class="op">=</span>precision, <span class="op">**</span>kwargs)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> graphviz.Source(re.sub(<span class="st">'Tree {'</span>, <span class="ss">f'Tree </span><span class="ch">{{</span><span class="ss"> size=</span><span class="sc">{</span>size<span class="sc">}</span><span class="ss">; ratio=</span><span class="sc">{</span>ratio<span class="sc">}</span><span class="ss">'</span>, s))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cluster_columns(df, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">6</span>), font_size<span class="op">=</span><span class="dv">12</span>):</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    corr <span class="op">=</span> np.<span class="bu">round</span>(scipy.stats.spearmanr(df).correlation, <span class="dv">4</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    corr_condensed <span class="op">=</span> hc.distance.squareform(<span class="dv">1</span><span class="op">-</span>corr)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> hc.linkage(corr_condensed, method<span class="op">=</span><span class="st">'average'</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>figsize)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    hc.dendrogram(z, labels<span class="op">=</span>df.columns, orientation<span class="op">=</span><span class="st">'left'</span>, leaf_font_size<span class="op">=</span>font_size)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us also define some variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> Path(<span class="st">'data/datasets/autos.csv'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>results_path <span class="op">=</span> Path(<span class="st">'results/used_cars'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>results_path.mkdir (parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>target_variable <span class="op">=</span> <span class="st">'sale_duration'</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>outliers <span class="op">=</span> <span class="bu">dict</span> (numeric_variables_high<span class="op">=</span><span class="fl">0.99</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                 numeric_variables_low<span class="op">=</span><span class="fl">0.01</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                 date_created<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>add_datepart_flag <span class="op">=</span> <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cd ..</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/home/jaumeamllo/workspace/mine/tabularml</code></pre>
</div>
</div>
</section>
<section id="load-data" class="level2">
<h2 class="anchored" data-anchor-id="load-data">Load data</h2>
<p>The first step is to load the data and have a quick look at it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path, encoding<span class="op">=</span><span class="st">"ISO-8859-1"</span>, parse_dates<span class="op">=</span>[<span class="st">'dateCrawled'</span>, <span class="st">'dateCreated'</span>, <span class="st">'lastSeen'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>dateCrawled</th>
      <th>name</th>
      <th>seller</th>
      <th>offerType</th>
      <th>price</th>
      <th>abtest</th>
      <th>vehicleType</th>
      <th>yearOfRegistration</th>
      <th>gearbox</th>
      <th>powerPS</th>
      <th>model</th>
      <th>kilometer</th>
      <th>monthOfRegistration</th>
      <th>fuelType</th>
      <th>brand</th>
      <th>notRepairedDamage</th>
      <th>dateCreated</th>
      <th>nrOfPictures</th>
      <th>postalCode</th>
      <th>lastSeen</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2016-03-24 11:52:17</td>
      <td>Golf_3_1.6</td>
      <td>privat</td>
      <td>Angebot</td>
      <td>480</td>
      <td>test</td>
      <td>NaN</td>
      <td>1993</td>
      <td>manuell</td>
      <td>0</td>
      <td>golf</td>
      <td>150000</td>
      <td>0</td>
      <td>benzin</td>
      <td>volkswagen</td>
      <td>NaN</td>
      <td>2016-03-24</td>
      <td>0</td>
      <td>70435</td>
      <td>2016-04-07 03:16:57</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2016-03-24 10:58:45</td>
      <td>A5_Sportback_2.7_Tdi</td>
      <td>privat</td>
      <td>Angebot</td>
      <td>18300</td>
      <td>test</td>
      <td>coupe</td>
      <td>2011</td>
      <td>manuell</td>
      <td>190</td>
      <td>NaN</td>
      <td>125000</td>
      <td>5</td>
      <td>diesel</td>
      <td>audi</td>
      <td>ja</td>
      <td>2016-03-24</td>
      <td>0</td>
      <td>66954</td>
      <td>2016-04-07 01:46:50</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2016-03-14 12:52:21</td>
      <td>Jeep_Grand_Cherokee_"Overland"</td>
      <td>privat</td>
      <td>Angebot</td>
      <td>9800</td>
      <td>test</td>
      <td>suv</td>
      <td>2004</td>
      <td>automatik</td>
      <td>163</td>
      <td>grand</td>
      <td>125000</td>
      <td>8</td>
      <td>diesel</td>
      <td>jeep</td>
      <td>NaN</td>
      <td>2016-03-14</td>
      <td>0</td>
      <td>90480</td>
      <td>2016-04-05 12:47:46</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2016-03-17 16:54:04</td>
      <td>GOLF_4_1_4__3TÜRER</td>
      <td>privat</td>
      <td>Angebot</td>
      <td>1500</td>
      <td>test</td>
      <td>kleinwagen</td>
      <td>2001</td>
      <td>manuell</td>
      <td>75</td>
      <td>golf</td>
      <td>150000</td>
      <td>6</td>
      <td>benzin</td>
      <td>volkswagen</td>
      <td>nein</td>
      <td>2016-03-17</td>
      <td>0</td>
      <td>91074</td>
      <td>2016-03-17 17:40:17</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2016-03-31 17:25:20</td>
      <td>Skoda_Fabia_1.4_TDI_PD_Classic</td>
      <td>privat</td>
      <td>Angebot</td>
      <td>3600</td>
      <td>test</td>
      <td>kleinwagen</td>
      <td>2008</td>
      <td>manuell</td>
      <td>69</td>
      <td>fabia</td>
      <td>90000</td>
      <td>7</td>
      <td>diesel</td>
      <td>skoda</td>
      <td>nein</td>
      <td>2016-03-31</td>
      <td>0</td>
      <td>60437</td>
      <td>2016-04-06 10:17:21</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
<section id="cleaning-and-eda" class="level2">
<h2 class="anchored" data-anchor-id="cleaning-and-eda">Cleaning and EDA</h2>
<p>We first gather the numerical and categorical columns:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>numerical_variables <span class="op">=</span> [</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    x <span class="cf">for</span> x <span class="kw">in</span> df.dtypes.index </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="bu">str</span>(df.dtypes[x]).startswith (<span class="st">'int'</span>) <span class="kw">or</span> <span class="bu">str</span>(df.dtypes[x]).startswith (<span class="st">'float'</span>)) <span class="kw">and</span> x <span class="op">!=</span> <span class="st">'postalCode'</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>numerical_variables</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['price',
 'yearOfRegistration',
 'powerPS',
 'kilometer',
 'monthOfRegistration',
 'nrOfPictures']</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>categorical_variables <span class="op">=</span> <span class="bu">set</span> (df.columns).difference (numerical_variables)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>categorical_variables</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'abtest',
 'brand',
 'dateCrawled',
 'dateCreated',
 'fuelType',
 'gearbox',
 'lastSeen',
 'model',
 'name',
 'notRepairedDamage',
 'offerType',
 'postalCode',
 'seller',
 'vehicleType'}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>categorical_variables <span class="op">=</span> categorical_variables.difference ({<span class="st">'dateCrawled'</span>, <span class="st">'dateCreated'</span>, <span class="st">'name'</span>, <span class="st">'lastSeen'</span>})</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>categorical_variables <span class="op">=</span> <span class="bu">list</span> (categorical_variables)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="outliers" class="level3">
<h3 class="anchored" data-anchor-id="outliers">Outliers</h3>
<p>Next, we remove outliers found in the data. For that purpose, we first examine the statistics of numerical variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>price</th>
      <th>yearOfRegistration</th>
      <th>powerPS</th>
      <th>kilometer</th>
      <th>monthOfRegistration</th>
      <th>nrOfPictures</th>
      <th>postalCode</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>3.715280e+05</td>
      <td>371528.000000</td>
      <td>371528.000000</td>
      <td>371528.000000</td>
      <td>371528.000000</td>
      <td>371528.0</td>
      <td>371528.00000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>1.729514e+04</td>
      <td>2004.577997</td>
      <td>115.549477</td>
      <td>125618.688228</td>
      <td>5.734445</td>
      <td>0.0</td>
      <td>50820.66764</td>
    </tr>
    <tr>
      <th>std</th>
      <td>3.587954e+06</td>
      <td>92.866598</td>
      <td>192.139578</td>
      <td>40112.337051</td>
      <td>3.712412</td>
      <td>0.0</td>
      <td>25799.08247</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000e+00</td>
      <td>1000.000000</td>
      <td>0.000000</td>
      <td>5000.000000</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>1067.00000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1.150000e+03</td>
      <td>1999.000000</td>
      <td>70.000000</td>
      <td>125000.000000</td>
      <td>3.000000</td>
      <td>0.0</td>
      <td>30459.00000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>2.950000e+03</td>
      <td>2003.000000</td>
      <td>105.000000</td>
      <td>150000.000000</td>
      <td>6.000000</td>
      <td>0.0</td>
      <td>49610.00000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>7.200000e+03</td>
      <td>2008.000000</td>
      <td>150.000000</td>
      <td>150000.000000</td>
      <td>9.000000</td>
      <td>0.0</td>
      <td>71546.00000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2.147484e+09</td>
      <td>9999.000000</td>
      <td>20000.000000</td>
      <td>150000.000000</td>
      <td>12.000000</td>
      <td>0.0</td>
      <td>99998.00000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<ul>
<li>We see outliers in:</li>
</ul>
<ol type="1">
<li>Price: minimum value 0, and maximum value &gt; 2000M euros</li>
<li>Year of registration: minimum value 1000, and maximum value &gt; 3000</li>
<li>Month of registration: minimum value 0</li>
<li>powerPS: minimum value 0, maximum value 20K</li>
</ol>
<ul>
<li>We also see that nrOfPictures is always zero, so that it is not relevant</li>
</ul>
<p>We have two possibilities:</p>
<ol type="1">
<li>Remove rows with outliers</li>
<li>Treat outlier values as missing values</li>
</ol>
<p>In this analysis, we go for the second option.</p>
<p>Typical outlier detection methods:</p>
<ol type="1">
<li>Based on percentile</li>
<li>Based on z-score</li>
</ol>
<p>In this analysis, we go for the first option:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df_clean <span class="op">=</span> df.copy()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>df_clean[numerical_variables] <span class="op">=</span> df_clean[numerical_variables].<span class="bu">apply</span> (</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: x.mask ((x <span class="op">&lt;</span> x.quantile(outliers[<span class="st">'numeric_variables_low'</span>])) <span class="op">|</span> (x <span class="op">&gt;</span> x.quantile(outliers[<span class="st">'numeric_variables_high'</span>])))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># see if there are rows that have all values missing and need to be removed, and</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># check maximum ratio of missing values in one row</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>df_clean[numerical_variables].isna().<span class="bu">all</span>(axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">any</span>(), df_clean[numerical_variables].isna().mean(axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(False, 0.5)</code></pre>
</div>
</div>
</section>
<section id="remove-nrofpictures" class="level3">
<h3 class="anchored" data-anchor-id="remove-nrofpictures">Remove nrOfPictures</h3>
<p>We remove the column <code>nrOfPictures</code>, since it is not relevant:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df_clean <span class="op">=</span> df_clean.drop (columns<span class="op">=</span><span class="st">'nrOfPictures'</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>numerical_variables.remove (<span class="st">'nrOfPictures'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="datecreated" class="level3">
<h3 class="anchored" data-anchor-id="datecreated">dateCreated</h3>
<p>We examine the column <code>dateCreated</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df_clean.dateCreated.<span class="bu">max</span>()<span class="op">-</span>df_clean.dateCreated.<span class="bu">min</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Timedelta('759 days 00:00:00')</code></pre>
</div>
</div>
<p>The time span is more than 2 years. However, we see below that there are only few cases where the ad was posted more than few months ago, while the rest are just a few months old. To see that, we transform <code>dateCreated</code> to the offset in terms of number of months since the earliest ad in the dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>df_clean[<span class="st">'offset_date'</span>] <span class="op">=</span> (df_clean[<span class="st">'dateCreated'</span>]<span class="op">-</span>df_clean[<span class="st">'dateCreated'</span>].<span class="bu">min</span>()).dt.days</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df_clean.offset_date.hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="analysis_files/figure-html/cell-15-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Clearly, almost all the ads are in one bin. Let’s look at this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>number_ads, bins <span class="op">=</span> np.histogram (df_clean.offset_date)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>pd.DataFrame ([number_ads, bins[<span class="dv">1</span>:]], index<span class="op">=</span>[<span class="st">'number_ads'</span>,<span class="st">'bins'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>number_ads</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>4.0</td>
      <td>5.0</td>
      <td>53.0</td>
      <td>371464.0</td>
    </tr>
    <tr>
      <th>bins</th>
      <td>75.9</td>
      <td>151.8</td>
      <td>227.7</td>
      <td>303.6</td>
      <td>379.5</td>
      <td>455.4</td>
      <td>531.3</td>
      <td>607.2</td>
      <td>683.1</td>
      <td>759.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>In the table above, we see that the last bin is where almost all the ads are, followed by the second to last bin, with few ads. From the 5th bin downwards, there are only 2 ads.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>very_old_ads <span class="op">=</span> df_clean[df_clean.offset_date <span class="op">&lt;</span> <span class="dv">450</span>]</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>other_ads <span class="op">=</span> df_clean[df_clean.offset_date <span class="op">&gt;=</span> <span class="dv">450</span>]</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (<span class="st">'oldest ads created between: '</span>, very_old_ads.dateCreated.<span class="bu">min</span>(),very_old_ads.dateCreated.<span class="bu">max</span>())</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (<span class="st">'remaining ads created between: '</span>, other_ads.dateCreated.<span class="bu">min</span>(),other_ads.dateCreated.<span class="bu">max</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>oldest ads created between:  2014-03-10 00:00:00 2015-03-20 00:00:00
remaining ads created between:  2015-06-11 00:00:00 2016-04-07 00:00:00</code></pre>
</div>
</div>
<p>We have four options:</p>
<pre><code>- no outlier
- oldest (2014) is outlier
- two oldest (before mid year 2016) are outliers.
- all but the ones in the last two bins (with 53 and 371464 rows) are outliers 
- use a quantile as done for the other numerical variables.</code></pre>
<p>In this analysis, we use the third option: treat the two oldest ads as two outliers:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> outliers[<span class="st">'date_created'</span>]:</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    df_clean <span class="op">=</span> df_clean[df_clean.dateCreated <span class="op">&gt;=</span> <span class="st">'2015-06-01'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df_clean <span class="op">=</span> df_clean.drop (columns <span class="op">=</span> <span class="st">'offset_date'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="yearregistration-monthregistration" class="level3">
<h3 class="anchored" data-anchor-id="yearregistration-monthregistration">yearRegistration + monthRegistration</h3>
<p>We use <code>yearOfRegistration</code> and <code>monthOfRegistration</code> to calculate the age of the vehicle, in number of months since the ad was posted. We first look if the outlier removal removed suspicious low and high values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df_clean[[<span class="st">'monthOfRegistration'</span>,<span class="st">'yearOfRegistration'</span>]].describe().loc[[<span class="st">'min'</span>,<span class="st">'max'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>monthOfRegistration</th>
      <th>yearOfRegistration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>min</th>
      <td>0.0</td>
      <td>1978.0</td>
    </tr>
    <tr>
      <th>max</th>
      <td>12.0</td>
      <td>2018.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>There are still months with value 0, we treat them as missing values. We impute them using the middle of the year, month 6.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df_clean.loc [df_clean.monthOfRegistration<span class="op">==</span><span class="dv">0</span>, <span class="st">'monthOfRegistration'</span>] <span class="op">=</span> <span class="dv">6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>df_clean[<span class="st">'age'</span>] <span class="op">=</span> pd.to_datetime(df_clean.dateCreated.<span class="bu">max</span>()) <span class="op">-</span> pd.to_datetime ({</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'month'</span>: df_clean.monthOfRegistration,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'year'</span>: df_clean.yearOfRegistration,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'day'</span>: np.tile (<span class="dv">15</span>, df_clean.shape[<span class="dv">0</span>])}</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>df_clean[<span class="st">'age'</span>] <span class="op">=</span> df_clean[<span class="st">'age'</span>].dt.days</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>numerical_variables.remove (<span class="st">'yearOfRegistration'</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>numerical_variables.remove (<span class="st">'monthOfRegistration'</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>numerical_variables.append (<span class="st">'age'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="target-variable" class="level3">
<h3 class="anchored" data-anchor-id="target-variable">Target variable</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>df_clean[target_variable] <span class="op">=</span> (df_clean [<span class="st">'lastSeen'</span>] <span class="op">-</span> df_clean[<span class="st">'dateCreated'</span>]).dt.days</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="date-information" class="level3">
<h3 class="anchored" data-anchor-id="date-information">date information</h3>
<p>Depending on whether the ad was posted on a weekend, on holidays, etc., more people might be able to look at it and it might be sold more quickly. We add this information here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> add_datepart_flag:</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    country_holidays <span class="op">=</span> holidays.country_holidays(<span class="st">'DE'</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    df_clean[<span class="st">'holidays'</span>] <span class="op">=</span> [<span class="bu">int</span>(day <span class="kw">in</span> country_holidays) <span class="cf">for</span> day <span class="kw">in</span> df_clean.dateCreated]</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    df_clean[<span class="st">'day_of_week'</span>] <span class="op">=</span> df_clean.dateCreated.dt.dayofweek.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>numerical_variables.append (<span class="st">'day_of_week'</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>categorical_variables.append (<span class="st">'holidays'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>joblib.dump ([df_clean, numerical_variables, categorical_variables], results_path <span class="op">/</span> <span class="st">'df_clean.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['results/used_cars/df_clean.pkl']</code></pre>
</div>
</div>
</section>
<section id="histograms" class="level3">
<h3 class="anchored" data-anchor-id="histograms">Histograms</h3>
<p>We look at the resulting histograms to see if there are clear outliers. This doesn’t seem to be the case.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df_clean[<span class="st">'price'</span>].hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="analysis_files/figure-html/cell-28-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df_clean[<span class="st">'age'</span>].hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="analysis_files/figure-html/cell-29-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>df_clean[<span class="st">'powerPS'</span>].hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="analysis_files/figure-html/cell-30-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>df_clean[<span class="st">'kilometer'</span>].hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="analysis_files/figure-html/cell-31-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="split-data-and-preprocess" class="level2">
<h2 class="anchored" data-anchor-id="split-data-and-preprocess">Split data and preprocess</h2>
<p>The first step is to split the data in training and validation. For simplicity, e don’t use a test set here, although we should use it if we wanted to estimate the final accuracy after selecting our best model on the validation set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>train_idx, valid_idx <span class="op">=</span> train_test_split(np.arange(df_clean.shape[<span class="dv">0</span>]), test_size<span class="op">=</span><span class="fl">0.30</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>joblib.dump ([train_idx, valid_idx], results_path <span class="op">/</span> <span class="st">'indexes.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['results/used_cars/indexes.pkl']</code></pre>
</div>
</div>
<p>The second step is to preprocess the data. We do that with the help of <code>TabularPandas</code> in the <code>fastai</code> library:</p>
<ul>
<li><p>Using <code>Categorify</code>, we replace columns in <code>categorical_variables</code> list with numeric categorical columns. We use just an discrete value instead of using a one-hot encoding. This tends to work better for decision trees and random forests, as explored in “Splitting on Categorical Predictors in Random Forests”</p></li>
<li><p>Using <code>FillMissing</code>, we replace missing values with the median, and we create a boolean column that is True for any row where the value was missing</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>procs <span class="op">=</span> [Categorify, FillMissing]</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>tabular <span class="op">=</span> TabularPandas (df_clean, procs, categorical_variables, numerical_variables, y_names<span class="op">=</span>target_variable, splits<span class="op">=</span>(<span class="bu">list</span>(train_idx),<span class="bu">list</span>(valid_idx)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> Path(<span class="st">'data/datasets'</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>joblib.dump (tabular, path <span class="op">/</span> <span class="st">'tabular.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['data/datasets/tabular.pkl']</code></pre>
</div>
</div>
</section>
<section id="decision-tree" class="level2">
<h2 class="anchored" data-anchor-id="decision-tree">Decision Tree</h2>
<p>We start by fitting a very simple yet powerful type of model, the decision tree. A good characteristic of this type of model is that it is interpretable and allows to analyze the data and the important variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>tabular <span class="op">=</span> joblib.load (path <span class="op">/</span> <span class="st">'tabular.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>X, y <span class="op">=</span> tabular.train.xs, tabular.train.y</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>valid_X, valid_y <span class="op">=</span> tabular.valid.xs, tabular.valid.y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="visualization" class="level3">
<h3 class="anchored" data-anchor-id="visualization">Visualization</h3>
<p>We can visualize on which basis the tree splits the data. We see that:</p>
<pre><code>- The most important predictor is the `price`: the lower the price, the lower the duration of the sale. 
- The data where most errors happen is the one for large durations. This might be due to the few cases with a long duration, which could be considered almost outliers.</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> DecisionTreeRegressor(max_leaf_nodes<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>m.fit (X, y)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>draw_tree(m, X, size<span class="op">=</span><span class="dv">10</span>, leaves_parallel<span class="op">=</span><span class="va">True</span>, precision<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Could not load "/home/jaumeamllo/miniconda3/envs/tsforecast/bin/../lib/graphviz/libgvplugin_pango.so.6" - It was found, so perhaps one of its dependents was not.  Try ldd.
Warning: no value for width of non-ASCII character 226. Falling back to width of space character</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="analysis_files/figure-html/cell-39-output-2.svg" class="img-fluid"></p>
</div>
</div>
<p>We can visualize the same using the <code>dtreeviz</code> library:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>samp_idx <span class="op">=</span> np.random.permutation(<span class="bu">len</span>(y))[:<span class="dv">500</span>]</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>viz <span class="op">=</span> dtreeviz.model (m, X.iloc[samp_idx], y.iloc[samp_idx], feature_names<span class="op">=</span>X.columns, target_name<span class="op">=</span>target_variable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>viz.view (fontname<span class="op">=</span><span class="st">'DejaVu Sans'</span>, scale<span class="op">=</span><span class="dv">2</span>, label_fontsize<span class="op">=</span><span class="dv">16</span>,</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>        orientation<span class="op">=</span><span class="st">'LR'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/jaumeamllo/miniconda3/envs/tsforecast/lib/python3.10/site-packages/sklearn/base.py:420: UserWarning: X does not have valid feature names, but DecisionTreeRegressor was fitted with feature names
Warning: Could not load "/home/jaumeamllo/miniconda3/envs/tsforecast/bin/../lib/graphviz/libgvplugin_pango.so.6" - It was found, so perhaps one of its dependents was not.  Try ldd.
Warning: no value for width of non-ASCII character 226. Falling back to width of space character</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="analysis_files/figure-html/cell-41-output-2.svg" class="img-fluid"></p>
</div>
</div>
</section>
<section id="training" class="level3">
<h3 class="anchored" data-anchor-id="training">Training</h3>
<p>Let’s first start by training a full size decision tree.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>dt_model <span class="op">=</span> DecisionTreeRegressor()</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>dt_model.fit(X, y)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="evaluation" class="level3">
<h3 class="anchored" data-anchor-id="evaluation">Evaluation</h3>
<p>We use the root of the mean squared error as evaluation metric.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> r_mse (pred, y): </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">round</span>(math.sqrt(((pred<span class="op">-</span>y)<span class="op">**</span><span class="dv">2</span>).mean()), <span class="dv">6</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> m_rmse (dt_model, X, y): </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> r_mse(dt_model.predict(X), y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see at the error on the training set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>m_rmse (dt_model, X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.283855</code></pre>
</div>
</div>
<p>… and on the validation set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>m_rmse (dt_model, valid_X, valid_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>11.614361</code></pre>
</div>
</div>
<p>We can see that we are clearly overfitting. Let’s look at the number of leaves, and compare it against the total number of observations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>dt_model.get_n_leaves(), <span class="bu">len</span>(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(201472, 260068)</code></pre>
</div>
</div>
<p>The number of leaves is similar to the number of observations. We need to reduce the size of the decision tree:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>dt_model <span class="op">=</span> DecisionTreeRegressor (min_samples_leaf<span class="op">=</span><span class="dv">25</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>dt_model.fit (tabular.train.xs, tabular.train.y)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>m_rmse (dt_model, X, y), m_rmse(dt_model, valid_X, valid_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(7.683234, 8.817406)</code></pre>
</div>
</div>
<p>We get a much better error on validation set, let’s see the number of leaves:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>dt_model.get_n_leaves()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>7949</code></pre>
</div>
</div>
</section>
</section>
<section id="random-forest" class="level2">
<h2 class="anchored" data-anchor-id="random-forest">Random Forest</h2>
<p>We have built a baseline using Decision Trees. Let us explore now the use of Random Rorests</p>
<section id="training-1" class="level3">
<h3 class="anchored" data-anchor-id="training-1">Training</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fitted_rf (X, y, n_estimators<span class="op">=</span><span class="dv">128</span>, max_features<span class="op">=</span><span class="fl">0.5</span>, min_samples_leaf<span class="op">=</span><span class="dv">5</span>, <span class="op">**</span>kwargs):</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> RandomForestRegressor (</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>        n_jobs<span class="op">=-</span><span class="dv">1</span>, n_estimators<span class="op">=</span>n_estimators, max_features<span class="op">=</span>max_features,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>        min_samples_leaf<span class="op">=</span>min_samples_leaf, oob_score<span class="op">=</span><span class="va">True</span>, <span class="op">**</span>kwargs</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    ).fit(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>rf_model <span class="op">=</span> fitted_rf (X, y)<span class="op">;</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>joblib.dump (rf_model, results_path <span class="op">/</span> <span class="st">'rf_model1.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="evaluation-1" class="level3">
<h3 class="anchored" data-anchor-id="evaluation-1">Evaluation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>m_rmse (rf_model, X, y), m_rmse(rf_model, valid_X, valid_y), r_mse (rf_model.oob_prediction_, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(6.048382, 8.272029, 8.215691)</code></pre>
</div>
</div>
<p>We see whether using another rule like the <code>sqrt</code> for calculating <code>max_features</code> per tree improves the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>rf_model_2 <span class="op">=</span> fitted_rf (X, y, max_features<span class="op">=</span><span class="st">'sqrt'</span>)<span class="op">;</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>m_rmse (rf_model_2, X, y), m_rmse(rf_model_2, valid_X, valid_y), r_mse(rf_model_2.oob_prediction_, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(6.649456, 8.296415, 8.233054)</code></pre>
</div>
</div>
<p>It doesnt’ improve. We could play with the ratio of max features, min samples per leaf, and other hyper-parameters. We leave this as future work.</p>
</section>
<section id="visualization-1" class="level3">
<h3 class="anchored" data-anchor-id="visualization-1">Visualization</h3>
<p>Let’s see the impact of n_estimators on the performance:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings (<span class="st">'ignore'</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> np.stack([t.predict(valid_X) <span class="cf">for</span> t <span class="kw">in</span> rf_model.estimators_])</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>plt.plot([r_mse(preds[:i<span class="op">+</span><span class="dv">1</span>].mean(<span class="dv">0</span>), valid_y) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">128</span>)])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="analysis_files/figure-html/cell-53-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We see that the accuracy plateaus from 80 estimators onwards</p>
</section>
<section id="interpretation" class="level3">
<h3 class="anchored" data-anchor-id="interpretation">Interpretation</h3>
<section id="confidence" class="level4">
<h4 class="anchored" data-anchor-id="confidence">Confidence</h4>
<p>We look at the standard deviation of the predictions across the different trees. For those sales where there is low standard deviation, most of the trees agree on the sale duration estimate. This is useful in production, to maybe avoid providing a predition for those requests where there is little agreement on the sale duration.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> np.stack([t.predict(valid_X) <span class="cf">for</span> t <span class="kw">in</span> rf_model.estimators_])</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>preds_std <span class="op">=</span> preds.std(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>plt.hist (preds_std)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="analysis_files/figure-html/cell-55-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We see that there is in general high standard deviation for most sales, except for few cases.</p>
</section>
<section id="feature-importance" class="level4">
<h4 class="anchored" data-anchor-id="feature-importance">Feature importance</h4>
<p>Let’s look at what features are most important for the regression task:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rf_feat_importance (rf_model, df):</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame({<span class="st">'cols'</span>:df.columns, <span class="st">'imp'</span>:rf_model.feature_importances_}).sort_values(<span class="st">'imp'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>importance <span class="op">=</span> rf_feat_importance (rf_model, X)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>importance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>cols</th>
      <th>imp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>7</th>
      <td>postalCode</td>
      <td>0.193067</td>
    </tr>
    <tr>
      <th>14</th>
      <td>price</td>
      <td>0.184392</td>
    </tr>
    <tr>
      <th>17</th>
      <td>age</td>
      <td>0.153438</td>
    </tr>
    <tr>
      <th>15</th>
      <td>powerPS</td>
      <td>0.099052</td>
    </tr>
    <tr>
      <th>6</th>
      <td>model</td>
      <td>0.088209</td>
    </tr>
    <tr>
      <th>0</th>
      <td>brand</td>
      <td>0.061477</td>
    </tr>
    <tr>
      <th>18</th>
      <td>day_of_week</td>
      <td>0.060955</td>
    </tr>
    <tr>
      <th>3</th>
      <td>vehicleType</td>
      <td>0.042012</td>
    </tr>
    <tr>
      <th>16</th>
      <td>kilometer</td>
      <td>0.036495</td>
    </tr>
    <tr>
      <th>9</th>
      <td>abtest</td>
      <td>0.023295</td>
    </tr>
    <tr>
      <th>4</th>
      <td>fuelType</td>
      <td>0.016574</td>
    </tr>
    <tr>
      <th>8</th>
      <td>gearbox</td>
      <td>0.015988</td>
    </tr>
    <tr>
      <th>5</th>
      <td>notRepairedDamage</td>
      <td>0.015318</td>
    </tr>
    <tr>
      <th>10</th>
      <td>holidays</td>
      <td>0.006917</td>
    </tr>
    <tr>
      <th>11</th>
      <td>price_na</td>
      <td>0.001413</td>
    </tr>
    <tr>
      <th>13</th>
      <td>age_na</td>
      <td>0.000947</td>
    </tr>
    <tr>
      <th>12</th>
      <td>powerPS_na</td>
      <td>0.000451</td>
    </tr>
    <tr>
      <th>1</th>
      <td>seller</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>offerType</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>We see that the most important features are:</p>
<pre><code>- postalCode: probably due to the higher density of population, and thus buyers, in certain areas.
- price: cheaper cars are sold faster.
- age: newer is better</code></pre>
<p>Surprisingly, the day of the week plays a role even more important than the number of kilometers, to be sold faster, maybe because people look at ads more at certain days of the week.</p>
<p>Let’s look at the same graphically:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_feature_importance (importance):</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> importance.plot(<span class="st">'cols'</span>, <span class="st">'imp'</span>, <span class="st">'barh'</span>, figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">7</span>), legend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>plot_feature_importance(importance)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="analysis_files/figure-html/cell-58-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="removing-variables" class="level3">
<h3 class="anchored" data-anchor-id="removing-variables">Removing variables</h3>
<p>We see if we can improve the performance by removing those features that have very little importance and might be adding noise:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_removing_variables (importance, X, y, valid_X, valid_y, threhsold):</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    to_keep <span class="op">=</span> importance[importance.imp<span class="op">&gt;</span>threhsold].cols</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    X_imp <span class="op">=</span> X[to_keep]</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    valid_X_imp <span class="op">=</span> valid_X[to_keep]</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    rf_model <span class="op">=</span> fitted_rf(X_imp, y)</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (m_rmse(rf_model, X_imp, y), m_rmse(rf_model, valid_X_imp, valid_y), r_mse (rf_model.oob_prediction_, y))</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rf_model, X_imp, valid_X_imp, to_keep</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>rf_model, X_imp, valid_X_imp, to_keep <span class="op">=</span> evaluate_removing_variables (importance, X, y, valid_X, valid_y, <span class="fl">0.0001</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>joblib.dump (rf_model, results_path <span class="op">/</span> <span class="st">'removing_low_importance.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>6.045863 8.268369 8.211243</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>['results/used_cars/removing_low_importance.pkl']</code></pre>
</div>
</div>
<p>There is almost no improvement, let’s see a bit more agressive pruning:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>rf_model2, X_imp2, valid_X_imp2, to_keep2 <span class="op">=</span> evaluate_removing_variables (importance, X, y, valid_X, valid_y, <span class="fl">0.001</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>6.050095 8.272465 8.213242</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>rf_model2, X_imp2, valid_X_imp2, to_keep2 <span class="op">=</span> evaluate_removing_variables (importance, X, y, valid_X, valid_y, <span class="fl">0.005</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>6.010566 8.271691 8.210651</code></pre>
</div>
</div>
<p>The best threshold seems to be 0.0001. Let’s use it and look at the feature importance again, after removing variables with low importance:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>importance <span class="op">=</span> rf_feat_importance(rf_model, X_imp)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>plot_feature_importance(importance)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="analysis_files/figure-html/cell-63-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="removing-redundant-variables" class="level3">
<h3 class="anchored" data-anchor-id="removing-redundant-variables">Removing redundant variables</h3>
<p>We see if there are variables that might be closely correlated, in terms of ranking:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>cluster_columns(X_imp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="analysis_files/figure-html/cell-64-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>PowerPS and price seem to be quite correlated. We see what happens when we remove each of the variables in turn. To do it quickly, we use the out-of-bag score, by using a random forest where each tree is trained on a smaller subset of data, so that the out-of-bag score is measured on the remaining subset. This score indicates the generalization provided, being the higher the better.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_oob (df, y):</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> RandomForestRegressor(n_estimators<span class="op">=</span><span class="dv">40</span>, min_samples_leaf<span class="op">=</span><span class="dv">15</span>,</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>        max_samples<span class="op">=</span><span class="dv">50000</span>, max_features<span class="op">=</span><span class="fl">0.5</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>, oob_score<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    m.fit(df, y)</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> m.oob_score_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see the score of the original features:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fitted_rf2 (X, y):</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> RandomForestRegressor (</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>        n_estimators<span class="op">=</span><span class="dv">40</span>, min_samples_leaf<span class="op">=</span><span class="dv">15</span>,</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>        max_samples<span class="op">=</span><span class="dv">50000</span>, max_features<span class="op">=</span><span class="fl">0.5</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>, oob_score<span class="op">=</span><span class="va">True</span>).fit(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>original_oob <span class="op">=</span> get_oob(X_imp, y)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>original_oob</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.06008218588804892</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>oob_scores <span class="op">=</span> {c:get_oob(X_imp.drop(c, axis<span class="op">=</span><span class="dv">1</span>), y) <span class="cf">for</span> c <span class="kw">in</span> (importance.cols)}</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>oob_scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'postalCode': 0.058280710022504234,
 'price': 0.0415493436634512,
 'age': 0.05244495695648832,
 'powerPS': 0.059019327633660135,
 'model': 0.0593482908544406,
 'brand': 0.058739696982127,
 'day_of_week': 0.05945691943436404,
 'vehicleType': 0.05943518125387026,
 'kilometer': 0.05984718680711576,
 'abtest': 0.06071818811404983,
 'fuelType': 0.060080938385732696,
 'gearbox': 0.06072952180624125,
 'notRepairedDamage': 0.06106010397906847,
 'holidays': 0.05685565776346668,
 'price_na': 0.060948957015006355,
 'age_na': 0.06027832457888893,
 'powerPS_na': 0.06106806907313633}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>{k:oob_scores[k] <span class="cf">for</span> k <span class="kw">in</span> oob_scores <span class="cf">if</span> oob_scores[k] <span class="op">&gt;</span> original_oob}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'abtest': 0.06071818811404983,
 'gearbox': 0.06072952180624125,
 'notRepairedDamage': 0.06106010397906847,
 'price_na': 0.060948957015006355,
 'age_na': 0.06027832457888893,
 'powerPS_na': 0.06106806907313633}</code></pre>
</div>
</div>
<p>It seems that dropping the notRepairedDamage, abtest, and powerPS_na might be beneficial</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_removing_redundant (to_drop, X_imp, y, valid_X, valid_y):</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">'OOB score: '</span>, get_oob(X_imp.drop(to_drop, axis<span class="op">=</span><span class="dv">1</span>), y))</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    X_final <span class="op">=</span> X_imp.drop(to_drop, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    valid_X_final <span class="op">=</span> valid_X_imp.drop(to_drop, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    rf_model <span class="op">=</span> fitted_rf(X_final, y)</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">'Regression errors: '</span>, m_rmse(rf_model, X_final, y), m_rmse(rf_model, valid_X_final, valid_y), r_mse(rf_model.oob_prediction_, y))</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rf_model, X_final, valid_X_final</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>rf_model, X_final, valid_X_final <span class="op">=</span> evaluate_removing_redundant ([<span class="st">'abtest'</span>, <span class="st">'notRepairedDamage'</span>, <span class="st">'powerPS_na'</span>], X_imp, y, valid_X, valid_y)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>joblib.dump ([rf_model, X_final, valid_X_final], results_path <span class="op">/</span> <span class="st">'removing_redundant.pkl'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>OOB score:  0.0611047486037124
Regression errors:  6.050136 8.261787 8.202955</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>['results/used_cars/removing_redundant.pkl']</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>rf_model2, X_final2, valid_X_final2 <span class="op">=</span> evaluate_removing_redundant ([<span class="st">'notRepairedDamage'</span>, <span class="st">'powerPS_na'</span>], X_imp, y, valid_X, valid_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>OOB score:  0.0606092565973716
Regression errors:  6.065446 8.26426 8.207189</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>rf_model2, X_final2, valid_X_final2 <span class="op">=</span> evaluate_removing_redundant ([<span class="st">'notRepairedDamage'</span>], X_imp, y, valid_X, valid_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>OOB score:  0.060027249156653584
Regression errors:  6.03148 8.262977 8.207328</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>rf_model2, X_final2, valid_X_final2 <span class="op">=</span> evaluate_removing_redundant ([<span class="st">'abtest'</span>], X_imp, y, valid_X, valid_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>OOB score:  0.060528790706093516
Regression errors:  6.037068 8.266976 8.205677</code></pre>
</div>
</div>
<p>We select the model without [‘abtest’, ‘notRepairedDamage’, ‘powerPS_na’]. The result is slightly better, with lower number of variables, which tends to be good.</p>
</section>
</section>
<section id="neural-network" class="level2">
<h2 class="anchored" data-anchor-id="neural-network">Neural Network</h2>
<p>We use a similar preprocessing as the one used for RF, but with two important differences: - The numerical variables are standard normalized. - The categorical variables will be passed to an embedding layer in the Neural Network, which maps discrete integers to embeddings that have been learned to optimally represent each category in the variable. This tends to be a bit more effective and efficient than using one-hot-encoding.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>selected_columns <span class="op">=</span> <span class="bu">set</span> (X_final.columns).intersection(df_clean.columns)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>df_nn <span class="op">=</span> (df_clean[<span class="bu">list</span>(selected_columns) <span class="op">+</span> [target_variable]]).copy()</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>df_nn[target_variable] <span class="op">=</span> df_nn[target_variable].astype (np.float32)</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>categorical_variables <span class="op">=</span> <span class="bu">set</span> (selected_columns).intersection (categorical_variables)</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>numerical_variables <span class="op">=</span> <span class="bu">set</span> (selected_columns).intersection (numerical_variables)</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>procs <span class="op">=</span> [Categorify, FillMissing, Normalize]</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>tabular <span class="op">=</span> TabularPandas (df_nn, procs, <span class="bu">list</span>(categorical_variables), <span class="bu">list</span>(numerical_variables), y_names<span class="op">=</span>target_variable, splits<span class="op">=</span>(<span class="bu">list</span>(train_idx),<span class="bu">list</span>(valid_idx)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use a relatively high batch-size due to the fact that tabular data does not occupy much memory.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> tabular.dataloaders(<span class="dv">1024</span>)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> tabular.train.y</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> tabular_learner(dls, y_range<span class="op">=</span>(np.floor(y.<span class="bu">min</span>()), np.ceil(y.<span class="bu">max</span>())), layers<span class="op">=</span>[<span class="dv">500</span>,<span class="dv">250</span>],</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>                        n_out<span class="op">=</span><span class="dv">1</span>, loss_func<span class="op">=</span>F.mse_loss)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>SuggestedLRs(valley=0.001737800776027143)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="analysis_files/figure-html/cell-76-output-4.png" class="img-fluid"></p>
</div>
</div>
<p>We try first with learning rate 1e-2 and 10 epochs:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">10</span>, <span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>602.610474</td>
      <td>76.169884</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>1</td>
      <td>78.452293</td>
      <td>79.093147</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>2</td>
      <td>72.395233</td>
      <td>75.213257</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>3</td>
      <td>68.382301</td>
      <td>73.556313</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>4</td>
      <td>64.683945</td>
      <td>75.480438</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>5</td>
      <td>61.083923</td>
      <td>77.244652</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>6</td>
      <td>50.728420</td>
      <td>79.223137</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>7</td>
      <td>43.104126</td>
      <td>84.684929</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>8</td>
      <td>34.933899</td>
      <td>85.208206</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>9</td>
      <td>30.915373</td>
      <td>87.217155</td>
      <td>00:10</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>We see that something close to 4 or 5 epochs is better</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> tabular_learner(dls, y_range<span class="op">=</span>(np.floor(y.<span class="bu">min</span>()), np.ceil(y.<span class="bu">max</span>())), layers<span class="op">=</span>[<span class="dv">500</span>,<span class="dv">250</span>],</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>                        n_out<span class="op">=</span><span class="dv">1</span>, loss_func<span class="op">=</span>F.mse_loss)</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">4</span>, <span class="fl">1e-2</span>)</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>preds, targs <span class="op">=</span> learn.get_preds()</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>r_mse (preds,targs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>345.358978</td>
      <td>78.925217</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>1</td>
      <td>74.916069</td>
      <td>75.385986</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>2</td>
      <td>65.404991</td>
      <td>74.644577</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>3</td>
      <td>51.674995</td>
      <td>76.773880</td>
      <td>00:11</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>8.762071</code></pre>
</div>
</div>
<p>The validation error is 8.76, bigger than the one obtained by the RF. Let’s see with a lower learning rate:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>learn2 <span class="op">=</span> tabular_learner(dls, y_range<span class="op">=</span>(np.floor(y.<span class="bu">min</span>()), np.ceil(y.<span class="bu">max</span>())), layers<span class="op">=</span>[<span class="dv">500</span>,<span class="dv">250</span>],</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>                        n_out<span class="op">=</span><span class="dv">1</span>, loss_func<span class="op">=</span>F.mse_loss)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>learn2.fit_one_cycle(<span class="dv">10</span>, <span class="fl">1e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>12781.711914</td>
      <td>7655.472656</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>1</td>
      <td>333.679382</td>
      <td>107.907936</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>2</td>
      <td>68.636696</td>
      <td>75.976501</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>3</td>
      <td>60.806812</td>
      <td>77.812447</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>4</td>
      <td>54.039669</td>
      <td>81.903381</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>5</td>
      <td>46.701462</td>
      <td>79.440315</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>6</td>
      <td>37.569061</td>
      <td>79.386604</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>7</td>
      <td>29.916273</td>
      <td>80.873795</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>8</td>
      <td>24.533495</td>
      <td>81.103035</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>9</td>
      <td>21.414110</td>
      <td>81.744980</td>
      <td>00:10</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>We see that the loss is not better than using a bigger learning rate. Let’s see even bigger:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>learn2 <span class="op">=</span> tabular_learner(dls, y_range<span class="op">=</span>(np.floor(y.<span class="bu">min</span>()), np.ceil(y.<span class="bu">max</span>())), layers<span class="op">=</span>[<span class="dv">500</span>,<span class="dv">250</span>],</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>                        n_out<span class="op">=</span><span class="dv">1</span>, loss_func<span class="op">=</span>F.mse_loss)</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>learn2.fit_one_cycle(<span class="dv">4</span>, <span class="fl">1e-1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>198.138016</td>
      <td>131.202820</td>
      <td>00:10</td>
    </tr>
    <tr>
      <td>1</td>
      <td>75.276131</td>
      <td>75.907112</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>2</td>
      <td>113.341293</td>
      <td>151.957809</td>
      <td>00:11</td>
    </tr>
    <tr>
      <td>3</td>
      <td>150.795166</td>
      <td>151.957809</td>
      <td>00:10</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>Clearly, the best learning rate seems to be 0.01</p>
<p>We could now examine other hyper-parameters, like regularization, dropout, adding more layers or units per layer, adding batch-normalization, etc.</p>
</section>
<section id="ensemble-of-rf-and-nn" class="level2">
<h2 class="anchored" data-anchor-id="ensemble-of-rf-and-nn">Ensemble of RF and NN</h2>
<p>We see if using an ensemble of RF and NN improves the results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>preds, targs <span class="op">=</span> learn.get_preds()</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>rf_preds <span class="op">=</span> rf_model.predict(valid_X_final)</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>ens_preds <span class="op">=</span> (to_np(preds.squeeze()) <span class="op">+</span> rf_preds) <span class="op">/</span><span class="dv">2</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>r_mse(ens_preds,valid_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>8.339824</code></pre>
</div>
</div>
<p>While it improves the result of using NN, using RF alone seems to be a better option in this data.</p>
</section>
<section id="future-lines-of-work" class="level2">
<h2 class="anchored" data-anchor-id="future-lines-of-work">Future lines of work</h2>
<ul>
<li>As indicated above, we should now examine other hyper-parameters, like regularization, dropout, adding more layers or units per layer, adding batch-normalization, etc.</li>
<li>Given that a random forest seems to be the best type of model for this data, it is a good idea to explore using XGBoost, CatBoost, or other types of tree ensembles.</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>